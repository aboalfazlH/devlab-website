{% extends 'base/base.html' %}

{% block title %}{{ article.title }}{% endblock %}

{% block meta %}
<meta name="description" content="{{ article.title }}">
{% endblock %}

{% block styles %}
<style>
    /* تصاویر مقاله */
    .article-img {
        max-height: 350px;
        width: 100%;
        object-fit: cover;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
    }

    .article-img:hover {
        transform: scale(1.02);
    }

    /* توضیحات مقاله */
    .article-description {
        line-height: 1.8;
        font-size: 1.05rem;
        color: #333;
    }

    /* دکمه‌ها و اکشن‌ها */
    .article-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    /* نوتیفیکیشن کپی لینک */
    .copy-notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #28a745;
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
        z-index: 9999;
    }

    /* نمایش کامنت‌ها */
    .comments-section {
        margin-top: 2rem;
    }

    .comments-section ul {
        padding-left: 0;
    }

    .comments-section li {
        list-style: none;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }

    .comment-replies {
        padding-left: 1.5rem;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5" dir="rtl">

    <!-- عنوان مقاله -->
    <h1 class="fw-bold text-center mb-4">{{ article.title }}</h1>

    <div class="row align-items-center">
        {% if article.thumbnail %}
        <div class="col-md-4 text-center mb-4 mb-md-0">
            <img src="{{ article.thumbnail.url }}" class="article-img" alt="{{ article.title }}">
        </div>
        {% endif %}

        <div class="col-md-8">
            <div class="text-muted small mb-2">
                نویسنده: <strong><a href="{{ article.author.get_absolute_url }}">{{ article.author }}</a></strong>
                <span class="mx-2">|</span>
                {{ article.write_date|timesince }} قبل
                <p>تعداد بازدید: {{ article.views }}</p>
            </div>

            <div class="article-description">
                {% if article.description %}
                {{ article.description|safe }}
                {% else %}
                <p class="text-danger">برای این مقاله توضیحی ثبت نشده.</p>
                {% endif %}
            </div>

            <div class="article-actions">
                <button class="btn btn-outline-success btn-sm" onclick="copyLink()">کپی لینک</button>

                {% if user == article.author or user.is_superuser %}
                <a class="btn btn-outline-info btn-sm" href="{% url 'blog:article-update' article.slug %}">ویرایش
                    مقاله</a>
                <a class="btn btn-danger btn-sm" href="{% url 'blog:article-delete' article.slug %}">حذف مقاله</a>
                {% endif %}

                {% if user.is_superuser %}
                <form action="{% url 'blog:article-pin' article.slug %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button class="btn btn-primary btn-sm" type="submit">
                        {% if article.is_pin %}برداشتن سنجاق{% else %}سنجاق کردن{% endif %}
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <hr class="my-4">

    <!-- بخش کامنت‌ها -->
    <div class="comments-section">
        <h4 class="mb-3">نظرات</h4>

        {% if comments %}
        <ul>
            {% for comment in comments %}
            <li>
                <strong>{{ comment.user }}</strong>
                <span class="text-muted small">{{ comment.write_date|timesince }} قبل</span>
                <p>{{ comment.content }}</p>

                {% if comment.replies.exists %}
                <ul class="comment-replies">
                    {% for reply in comment.replies.all %}
                    <li>
                        <strong>{{ reply.user }}</strong>
                        <span class="text-muted small">{{ reply.write_date|timesince }} قبل</span>
                        <p>{{ reply.content }}</p>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted">هنوز نظری ثبت نشده است.</p>
        {% endif %}

        
        {% comment %}
        {# TODO #}
        <form method="post" action="{% url 'blog:add_comment' article.slug %}">
            {% csrf_token %}
            {{ comment_form.as_p }}
            <button type="submit" class="btn btn-primary btn-sm">ثبت نظر</button>
        </form>
        {% endcomment %}
            
    </div>

    <a href="{% url 'blog:articles' %}" class="btn btn-dark w-100 mt-4">
        بازگشت به لیست مقالات
    </a>
</div>

<div class="copy-notification" id="copyNotification">لینک کپی شد!</div>
{% endblock %}

{% block scripts %}
<script>
    function copyLink() {
        const textToCopy = window.location.href;

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(textToCopy)
                .then(() => showNotification())
                .catch(() => fallbackCopy(textToCopy));
        } else {
            fallbackCopy(textToCopy);
        }
    }

    function fallbackCopy(text) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand("copy");
            showNotification();
        } catch (err) {
            console.error('کپی نشد: ', err);
        }
        document.body.removeChild(textarea);
    }

    function showNotification() {
        const notif = document.getElementById('copyNotification');
        notif.classList.add('show');
        setTimeout(() => notif.classList.remove('show'), 1500);
    }
</script>
{% endblock %}