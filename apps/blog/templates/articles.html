{% extends 'base/base.html' %}
{% load static %}

{% block title %}
لیست مقالات
{% endblock title %}

{% block meta %}
<meta name="description" content="لیست مقالات وبسایت" />
{% endblock meta %}

{% block styles %}
<link rel="stylesheet" href="{% static 'css/article-list.css' %}" />
{% endblock styles %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-lg-9 col-md-8">
      <div class="d-flex justify-content-between align-items-center">
        <h1>
          مقالات {% if category %}
          <span class="badge bg-info text-dark">با برچسب {{ category.name }}</span>
          {% endif %}
        </h1>
        <a class="btn btn-primary" href="{% url 'blog:write-article' %}">نوشتن مقاله جدید</a>
      </div>
       {% if request.GET.category or request.GET.author %}
      <a href="{% url 'blog:articles' %}" class="btn btn-outline-secondary btn-sm mt-2">حذف فیلتر</a>
      {% endif %}
      <hr />

      {% for article in articles %}
      <div class="article-card {% if article.is_pin or article.most_visited %}pin{% endif %}"
        onclick="window.location='{{ article.get_absolute_url }}';">
        {% if article.thumbnail %}
        <img src="{{ article.thumbnail.url }}" class="thumbnail" alt="{{ article.title }}" />
        {% else %}
        <div class="thumbnail-placeholder">بدون تصویر</div>
        {% endif %}
        <div>
          <h3 class="article-title">{{ article.title }}</h3>
          {% if article.short_description %}
          <p class="article-desc">{{ article.short_description }}</p>
          {% elif article.description %}
          <p class="article-desc">{{ article.description|striptags|truncatewords:25 }}</p>
          {% else %}
          {% endif %}

          <p class="author-box">
            نویسنده: {{ article.author }}
            <span class="text-muted"> | {{ article.write_date|timesince }} قبل</span>
            <span class="text-muted"> | {{ article.views }} بازدید</span>
          </p>

          {% if article.is_pin %}
          <span class="badge bg-warning text-dark">ویژه</span>
          {% endif %}
          {% if article.most_visited %}
          <span class="badge bg-danger text-dark">پربازدید</span>
          {% endif %}
          {% for category in article.categories.all %}
          <span style="background-color:{{ category.color }};" class="badge">{{ category }}</span>
          {% empty %}
          {% endfor %}
        </div>
      </div>
      {% empty %}
      <div class="alert alert-warning text-center">هیچ مقاله‌ای یافت نشد.</div>
      {% endfor %}
      
      {% include 'components/pagination.html' %}
    </div>

    <div class="col-lg-3 col-md-4">
      <div class="sidebar-box">
        <h5 class="mb-3">دسته‌بندی‌ها</h5>
        {% for category in categories %}
        <a href="#" class="d-block mb-2 badge bg-light text-dark" style="font-size: 0.9rem; border: 1px solid #ccc"
          onclick="addFilterToUrl('category', '{{ category.slug }}')">
          {{ category.name }} ({{ category.article_count }})
        </a>
        {% endfor %}

        <h5 class="mb-3 mt-4">نویسندگان</h5>
        {% for author in authors %}
        <a href="#" class="d-block mb-2 badge bg-light text-dark" style="font-size: 0.9rem; border: 1px solid #ccc"
          onclick="addFilterToUrl('author', '{{ author.username }}')">
          {{ author.username }} ({{ author.article_count }})
        </a>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block scripts %}
<script>
  function addFilterToUrl(filterType, filterValue) {
    let url = new URL(window.location.href);
    let params = new URLSearchParams(url.search);
    let currentFilterValues = params.getAll(filterType);
    currentFilterValues.push(filterValue);
    params.delete(filterType);
    currentFilterValues.forEach(value => {
      params.append(filterType, value);
    });
    url.search = params.toString();
    window.location.href = url.toString();
  }
</script>
{% endblock %}
